<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepFlow Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background-color: #fdfbf7; /* Off-white / Á±≥ÁôΩËâ≤ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        /* Custom scrollbar for textarea if needed, keeping it subtle */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen py-10 px-4">

    <div id="app" class="max-w-2xl mx-auto space-y-12">
        <div class="fixed left-4 top-10 w-64 z-10">
            <div class="bg-white/80 backdrop-blur rounded-xl shadow-sm border border-stone-100 p-3 space-y-3">
                <div class="flex items-center gap-2">
                    <button @click="prevDay" class="w-9 h-9 flex items-center justify-center rounded-md border border-gray-200 text-gray-600 hover:bg-gray-50">
                        &lt;
                    </button>
                    <input type="date" v-model="selectedDate" class="flex-1 px-2 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-stone-200">
                    <button @click="nextDay" class="w-9 h-9 flex items-center justify-center rounded-md border border-gray-200 text-gray-600 hover:bg-gray-50">
                        &gt;
                    </button>
                </div>
                <button v-if="!isToday" @click="backToToday" class="w-full px-3 py-2 rounded-md bg-stone-700 text-white text-sm hover:bg-stone-800">
                    ÂõûÂà∞‰ªäÂ§©
                </button>
                <div class="text-xs text-gray-400 text-center">ÂΩìÂâçÊó•ÊúüÔºö{{ selectedDate }}</div>
            </div>
        </div>
        
        <!-- Ê®°Âùó 1ÔºöÊÄùÁª¥ÁºìÂÜ≤Âå∫ -->
        <section class="space-y-4">
            <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                üß† ÊÄùÁª¥ÁºìÂÜ≤Âå∫
            </h2>
            <div class="bg-white/50 rounded-xl shadow-sm border border-stone-100 overflow-hidden focus-within:ring-2 focus-within:ring-stone-200 transition-all duration-300">
                <textarea 
                    v-model="mindBuffer"
                    class="w-full h-40 p-4 bg-transparent resize-none focus:outline-none text-gray-600 placeholder-gray-400"
                    placeholder="Âú®ËøôÈáåÂç∏ËΩΩ‰Ω†ÁöÑÊÄùÁª™ÔºåÊääÊ∑∑‰π±ÂÜô‰∏ãÊù•..."
                ></textarea>
            </div>
        </section>

        <!-- Ê®°Âùó 2Ôºö‰Ω†ÁöÑÊØè‰∏ÄÊ≠•ÈÉΩÊòØÂú®ÊîπÂèò‰∏ñÁïå -->
        <section class="space-y-6">
            <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                ‚ö° ‰Ω†ÁöÑÊØè‰∏ÄÊ≠•ÈÉΩÊòØÂú®ÊîπÂèò‰∏ñÁïå
            </h2>
            
            <!-- ‰ªªÂä°ËæìÂÖ•Ê°Ü -->
            <div class="relative group">
                <input 
                    v-model="newTaskInput"
                    @keyup.enter="addTask"
                    type="text" 
                    placeholder="‰∏ã‰∏ÄÊ≠•Ë¶ÅÂÅö‰ªÄ‰πàÔºü(ÂõûËΩ¶Ê∑ªÂä†)" 
                    class="w-full px-4 py-3 bg-white rounded-lg shadow-sm border border-gray-100 focus:outline-none focus:ring-2 focus:ring-stone-200 transition-all placeholder-gray-400"
                >
                <div class="absolute right-3 top-3 text-gray-300 text-sm hidden group-focus-within:block">
                    Enter ‚Üµ
                </div>
            </div>

            <!-- ‰ªªÂä°ÂàóË°® -->
            <div class="space-y-3">
                <!-- ËøõË°å‰∏≠ÁöÑ‰ªªÂä° -->
                <div v-if="activeTasks.length === 0 && completedTasks.length === 0" class="text-center text-gray-400 py-8 text-sm italic">
                    ÈùôÂ¶ÇÊ≠¢Ê∞¥ÔºåÂä®Â¶ÇËÑ±ÂÖî„ÄÇ
                </div>

                <div v-for="task in activeTasks" :key="task.id" class="group bg-white rounded-lg p-3 shadow-sm border border-gray-50 hover:shadow-md transition-all duration-200">
                    <div class="flex items-start gap-3">
                        <!-- Checkbox -->
                        <div class="pt-1">
                            <input 
                                type="checkbox" 
                                v-model="task.completed"
                                class="w-5 h-5 rounded border-gray-300 text-stone-600 focus:ring-stone-200 cursor-pointer"
                            >
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="text-gray-700 break-words leading-relaxed">
                                {{ task.text }}
                            </div>

                            <!-- Â≠ê‰ªªÂä°Âå∫Âüü -->
                            <div v-if="task.showSubtasks" class="mt-3 pl-1 space-y-2 border-l-2 border-gray-100 ml-1">
                                <div v-for="subtask in task.subtasks" :key="subtask.id" class="flex items-center gap-2">
                                    <input 
                                        type="checkbox" 
                                        v-model="subtask.completed"
                                        class="w-4 h-4 rounded border-gray-300 text-stone-500 focus:ring-stone-200 cursor-pointer"
                                    >
                                    <span :class="{'line-through text-gray-400': subtask.completed, 'text-gray-600': !subtask.completed}" class="text-sm flex-1 break-words">
                                        {{ subtask.text }}
                                    </span>
                                    <button @click="deleteSubtask(task, subtask.id)" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity px-1">
                                        &times;
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 pt-1">
                                    <input 
                                        type="text" 
                                        v-model="task.newSubtaskInput"
                                        @keyup.enter="addSubtask(task)"
                                        placeholder="Ê∑ªÂä†Â≠ê‰ªªÂä°..."
                                        class="text-sm w-full bg-transparent border-b border-transparent focus:border-gray-200 focus:outline-none placeholder-gray-400 py-1"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Add Subtask Button -->
                        <button 
                            @click="toggleSubtasks(task)"
                            class="text-gray-400 hover:text-stone-600 p-1 rounded hover:bg-gray-50 transition-colors"
                            title="Ê∑ªÂä†/Â±ïÂºÄÂ≠ê‰ªªÂä°"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        
                        <!-- Delete Task Button (Hover only) -->
                        <button 
                            @click="deleteTask(task.id)"
                            class="text-gray-300 hover:text-red-400 p-1 rounded hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100"
                            title="Âà†Èô§‰ªªÂä°"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Â∑≤ÂÆåÊàê‰ªªÂä°ÊäòÂè†Èù¢Êùø -->
                <div v-if="completedTasks.length > 0" class="mt-8">
                    <button 
                        @click="showCompleted = !showCompleted"
                        class="flex items-center gap-2 text-sm text-gray-400 hover:text-gray-600 transition-colors w-full py-2"
                    >
                        <svg 
                            class="w-4 h-4 transition-transform duration-200" 
                            :class="{'rotate-90': showCompleted}"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                        >
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Â∑≤ÂÆåÊàê ({{ completedTasks.length }})
                    </button>
                    
                    <div v-show="showCompleted" class="space-y-2 mt-2 pl-2">
                        <div v-for="task in completedTasks" :key="task.id" class="flex items-center gap-3 opacity-60 hover:opacity-100 transition-opacity p-2 rounded-lg hover:bg-gray-50">
                            <input 
                                type="checkbox" 
                                v-model="task.completed"
                                class="w-5 h-5 rounded border-gray-300 text-stone-600 focus:ring-stone-200 cursor-pointer"
                            >
                            <span class="line-through text-gray-400 flex-1">{{ task.text }}</span>
                             <button @click="deleteTask(task.id)" class="text-gray-300 hover:text-red-400 p-1">
                                &times;
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ê®°Âùó 3Ôºö‰∏∞È•∂‰πãÊµ∑ -->
        <section class="space-y-4">
            <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                üíé ‰∏∞È•∂‰πãÊµ∑
            </h2>
            
            <div class="flex gap-2">
                <input 
                    v-model="newIdeaInput"
                    @keyup.enter="addIdea"
                    type="text" 
                    placeholder="ÊçïÊçâÁÅµÊÑü..." 
                    class="flex-1 px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-100 focus:outline-none focus:ring-2 focus:ring-stone-200 transition-all placeholder-gray-400"
                >
                <button 
                    @click="addIdea"
                    class="px-6 py-2 bg-stone-700 hover:bg-stone-800 text-white rounded-lg shadow-sm transition-colors duration-200 font-medium text-sm"
                >
                    ËÆ∞ÂΩï
                </button>
            </div>

            <div class="space-y-3 mt-4">
                <transition-group name="fade">
                    <div v-for="idea in ideas" :key="idea.id" class="bg-white p-4 rounded-lg shadow-sm border border-gray-50 flex flex-col gap-1 relative group">
                        <div class="text-gray-700 leading-relaxed">{{ idea.content }}</div>
                        <div class="text-xs text-gray-400 font-mono text-right mt-1">{{ formatTime(idea.timestamp) }}</div>
                        <button 
                            @click="deleteIdea(idea.id)"
                            class="absolute top-2 right-2 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </transition-group>
                <div v-if="ideas.length === 0" class="text-center text-gray-300 text-sm py-4">
                    ÊöÇÊó†ÁÅµÊÑüËÆ∞ÂΩï
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-300 text-xs py-8 space-y-4">
            <div>DeepFlow Web &copy; {{ new Date().getFullYear() }}</div>
            
            <!-- Êï∞ÊçÆÂ§á‰ªΩ‰∏éÊÅ¢Â§ç -->
            <div class="flex justify-center gap-4 opacity-50 hover:opacity-100 transition-opacity">
                <button @click="exportData" class="hover:text-stone-600 underline">ÂØºÂá∫Êï∞ÊçÆÂ§á‰ªΩ</button>
                <div class="relative">
                    <button class="hover:text-stone-600 underline">ÂØºÂÖ•Êï∞ÊçÆÊÅ¢Â§ç</button>
                    <input type="file" @change="importData" accept=".json" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
            </div>
        </footer>

    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const todayStr = () => new Date().toISOString().slice(0, 10);
                const selectedDate = ref(todayStr());
                const store = ref({});
                const ensureDay = (d) => {
                    if (!store.value[d]) {
                        store.value[d] = { mindBuffer: '', tasks: [], ideas: [] };
                    }
                };
                ensureDay(selectedDate.value);

                const mindBuffer = computed({
                    get: () => { ensureDay(selectedDate.value); return store.value[selectedDate.value].mindBuffer; },
                    set: (v) => { ensureDay(selectedDate.value); store.value[selectedDate.value].mindBuffer = v; }
                });

                const tasks = computed({
                    get: () => { ensureDay(selectedDate.value); return store.value[selectedDate.value].tasks; },
                    set: (v) => { ensureDay(selectedDate.value); store.value[selectedDate.value].tasks = v; }
                });

                const newTaskInput = ref('');
                const showCompleted = ref(false);

                const activeTasks = computed(() => tasks.value.filter(t => !t.completed));
                const completedTasks = computed(() => tasks.value.filter(t => t.completed));

                const addTask = () => {
                    const text = newTaskInput.value.trim();
                    if (!text) return;
                    
                    tasks.value.unshift({
                        id: Date.now(),
                        text: text,
                        completed: false,
                        subtasks: [],
                        showSubtasks: false,
                        newSubtaskInput: ''
                    });
                    newTaskInput.value = '';
                };

                const deleteTask = (id) => {
                    tasks.value = tasks.value.filter(t => t.id !== id);
                };

                const toggleSubtasks = (task) => {
                    task.showSubtasks = !task.showSubtasks;
                };

                const addSubtask = (task) => {
                    const text = task.newSubtaskInput.trim();
                    if (!text) return;

                    task.subtasks.push({
                        id: Date.now() + Math.random(),
                        text: text,
                        completed: false
                    });
                    task.newSubtaskInput = '';
                };

                const deleteSubtask = (task, subtaskId) => {
                    task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
                };

                // --- Ê®°Âùó 3Ôºö‰∏∞È•∂‰πãÊµ∑ ---
                const ideas = ref([]);
                const newIdeaInput = ref('');

                const addIdea = () => {
                    const content = newIdeaInput.value.trim();
                    if (!content) return;

                    ideas.value.unshift({
                        id: Date.now(),
                        content: content,
                        timestamp: Date.now()
                    });
                    newIdeaInput.value = '';
                };

                const deleteIdea = (id) => {
                    ideas.value = ideas.value.filter(i => i.id !== id);
                };

                const formatTime = (timestamp) => {
                    const date = new Date(timestamp);
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    return `${month}-${day} ${hours}:${minutes}`;
                };

                const exportData = () => {
                    const data = { store: store.value, selectedDate: selectedDate.value, version: 'v2', exportDate: new Date().toISOString() };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `deepflow_backup_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                const importData = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const parsed = JSON.parse(e.target.result);
                            if (confirm(`ÂáÜÂ§áÂØºÂÖ•Êï∞ÊçÆ (Â§á‰ªΩÊó∂Èó¥: ${parsed.exportDate || 'Êú™Áü•'})Ôºü\nËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÈ°µÈù¢ÁöÑÊâÄÊúâÊï∞ÊçÆÔºÅ`)) {
                                if (parsed.store) store.value = parsed.store;
                                if (parsed.selectedDate) selectedDate.value = parsed.selectedDate;
                                alert('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅ');
                            }
                        } catch (err) {
                            alert('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºåÊó†Ê≥ïÂØºÂÖ•');
                            console.error(err);
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                };

                const STORAGE_KEY_V2 = 'deepflow_store_v2';
                const STORAGE_KEY_V1 = 'deepflow_data_v1';

                const loadData = () => {
                    const v2 = localStorage.getItem(STORAGE_KEY_V2);
                    if (v2) {
                        try {
                            const parsed = JSON.parse(v2);
                            store.value = parsed;
                        } catch (e) {
                            console.error('Failed to load data', e);
                        }
                    } else {
                        const v1 = localStorage.getItem(STORAGE_KEY_V1);
                        if (v1) {
                            try {
                                const old = JSON.parse(v1);
                                const d = todayStr();
                                store.value[d] = {
                                    mindBuffer: old.mindBuffer || '',
                                    tasks: old.tasks || [],
                                    ideas: old.ideas || []
                                };
                            } catch (e) {
                                console.error('Failed to migrate data', e);
                            }
                        }
                    }
                    ensureDay(selectedDate.value);
                };

                const saveData = () => {
                    localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(store.value));
                };

                watch(store, () => { saveData(); }, { deep: true });
                watch(selectedDate, (d) => { ensureDay(d); });

                const prevDay = () => {
                    const dt = new Date(selectedDate.value);
                    dt.setDate(dt.getDate() - 1);
                    selectedDate.value = dt.toISOString().slice(0,10);
                };
                const nextDay = () => {
                    const dt = new Date(selectedDate.value);
                    dt.setDate(dt.getDate() + 1);
                    selectedDate.value = dt.toISOString().slice(0,10);
                };
                const backToToday = () => { selectedDate.value = todayStr(); };
                const isToday = computed(() => selectedDate.value === todayStr());

                onMounted(() => {
                    loadData();
                });

                return {
                    selectedDate,
                    prevDay,
                    nextDay,
                    backToToday,
                    isToday,
                    mindBuffer,
                    newTaskInput,
                    activeTasks,
                    completedTasks,
                    showCompleted,
                    addTask,
                    deleteTask,
                    toggleSubtasks,
                    addSubtask,
                    deleteSubtask,
                    newIdeaInput,
                    ideas,
                    addIdea,
                    deleteIdea,
                    formatTime,
                    exportData,
                    importData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
